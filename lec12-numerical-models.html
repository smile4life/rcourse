<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Madeleine Bonsma-Fisher" />


<title>Numerically solving population models in R</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />
<link rel="icon" type="image/png" href="image/favicon.png">
<style type="text/css">

table {
    border-collapse: collapse;
}

thead {
    border-top: solid #DCDCDC;
    border-bottom: solid #DCDCDC;
}

tr.odd {
    background-color: #F8F8F8;
}

tr:last-child {
    border-bottom: solid #DCDCDC;
}

</style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 54px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h2 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h3 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h4 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h5 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h6 {
  padding-top: 59px;
  margin-top: -59px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">EEB313H1</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">
    <span class="fa fa-map-o"></span>
     
    Syllabus
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Lectures
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="lec01-introduction.html">Sept. 10: Intro to course, programming, RStudio, and R Markdown</a>
    </li>
    <li>
      <a href="lec02-basic-r.html">Sept. 12: Assignment, vectors, functions</a>
    </li>
    <li>
      <a href="lec03-basic-r.html">Sept. 17: Data frames, intro to dplyr</a>
    </li>
    <li>
      <a href="lec04-dplyr.html">Sept. 19: Data wrangling in dplyr, ggplot, tidy data</a>
    </li>
    <li>
      <a href="lec05-dplyr.html">Sept. 24: More dplyr and ggplot</a>
    </li>
    <li class="dropdown-header">Sept. 26: Exploratory data analysis</li>
    <li class="dropdown-header">Oct. 01: Linear models and statistical modelling</li>
    <li class="dropdown-header">Oct. 03: Mixed effects models</li>
    <li class="dropdown-header">Oct. 08: Simulating data: Randomization tests</li>
    <li class="dropdown-header">Oct. 10: Multivariate stats</li>
    <li class="dropdown-header">Oct. 15: Model selection</li>
    <li class="dropdown-header">Oct. 17: Numerically solving population models</li>
    <li class="dropdown-header">Oct. 22: Time series analysis</li>
    <li class="dropdown-header">Oct. 24: Datasets, hypothesis, begin projects</li>
    <li class="dropdown-header">Oct. 29: Reproducible science</li>
    <li class="dropdown-header">Oct. 31: Reproducible science</li>
    <li class="dropdown-header">Nov. 12: Project work (no lesson)</li>
    <li class="dropdown-header">Nov. 14: Project work (no lesson)</li>
    <li class="dropdown-header">Nov. 19: Project work (no lesson)</li>
    <li class="dropdown-header">Nov. 21: Project work (no lesson)</li>
    <li class="dropdown-header">Nov. 26: Project work (no lesson)</li>
    <li class="dropdown-header">Nov. 28: Project work (no lesson)</li>
    <li class="dropdown-header">Dec. 03: Project work (no lesson)</li>
    <li class="dropdown-header">Dec. 05: Group presentations (no lesson)</li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-book"></span>
     
    Assignments
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Assignment 1</li>
    <li class="dropdown-header">Assignment 2</li>
    <li class="dropdown-header">Assignment 3</li>
    <li class="dropdown-header">Assignment 4</li>
    <li class="dropdown-header">Assignment 5</li>
    <li class="dropdown-header">Assignment 6</li>
    <li class="dropdown-header">Assignment 7</li>
    <li class="dropdown-header">Assignment 8</li>
    <li class="dropdown-header">Final project</li>
  </ul>
</li>
<li>
  <a href="resources.html">
    <span class="fa fa-question"></span>
     
    Resources and FAQ
  </a>
</li>
<li>
  <a href="about.html">
    <span class="fa fa-info"></span>
     
    About
  </a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-bars"></span>
     
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="mailto:ahmed.hasan@mail.utoronto.ca">
        <span class="fa fa-envelope"></span>
         
        Contact
      </a>
    </li>
    <li>
      <a href="https://github.com/uoftcoders/rcourse">
        <span class="fa fa-github"></span>
         
        GitHub
      </a>
    </li>
  </ul>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Numerically solving population models in R</h1>
<h4 class="author">Madeleine Bonsma-Fisher</h4>

</div>


<div id="lesson-preamble" class="section level2">
<h2>Lesson preamble</h2>
<p>In developing these lectures I have referred heavily to the notes from Nonlinear Physics, <a href="https://www.physics.utoronto.ca/students/graduate-courses/current/phy1460s">PHY1460</a>, which I would encourage anyone who is interested in getting more in depth on the quantitative analysis of dynamical systems to take or audit. I also refer to “Nonlinear Dynamics and Chaos” by Steven Strogatz, a very good textbook which you might find helpful. You can find the pdf online, it’s available as an e-book from the UofT library, and it’s available in the Physics library as a hard copy course reserve.</p>
<blockquote>
<h3 id="learning-objectives">Learning objectives</h3>
<ul>
<li>Appreciate the purpose and usefulness of population models in ecology</li>
<li>Understand the use of differential equations to model populations</li>
<li>Qualitatively analyze one-dimensional population models by hand and in R
<ul>
<li>Find fixed points graphically in R</li>
<li>Analyze stability graphically in R</li>
</ul></li>
<li>Numerically solve differential equations in R using R’s ODE solver</li>
</ul>
<h3 id="lesson-outline">Lesson outline</h3>
<p>Total lesson time: 2 hours</p>
<ul>
<li>Introduction to modelling (10 min)</li>
<li>Setting up a model (20 min)</li>
<li>Analysis of one-dimensional models (40 min)</li>
<li>Numerically solving differential equations (30 min)</li>
</ul>
<h3 id="setup">Setup</h3>
<ul>
<li><code>install.packages('tidyverse')</code> (done already)</li>
<li><code>install.packages('deSolve')</code></li>
</ul>
</blockquote>
<!-- - Optional: install `animation`: run `install.packages('animation'). This is only if you want to play around with the simulations at the bottom later. -->
<hr />
</div>
<div id="introduction---why-model-populations" class="section level2">
<h2>Introduction - why model populations?</h2>
<p>Until now in this class, we’ve been talking about (mostly) linear models that are used to determine how different variables relate to each other in a dataset (AKA “stats”). This week, I’ll be talking about models that are used to summarize a biological idea about how populations behave in time. The specific models I’ll be talking about will likely be familiar to you from your previous ecology classes.</p>
<!--*How many have taken some theoretical ecology before?*-->
<ol style="list-style-type: decimal">
<li>Models can simplify a complex system and help us identify what’s important.
<ul>
<li>Biology is extremely complicated.</li>
<li>Models summarize what we think we know about a system, force us to identify the important parameters, and encourage us to distill them down to a manageable number of parameters.</li>
<li>Data don’t always fit theoretical models, but it is helpful to interpret data with a larger theoretical framework in mind.</li>
</ul></li>
<li>Models can show us something we didn’t expect, that we couldn’t intuit from just thinking about the problem.
<ul>
<li>if your model is simple enough, it can be predictive in a broadly applicable way. We’ll talk about some famous ecological models, and the assignment will include more examples. I will also include some famous examples from physics, where this field is known as <strong>nonlinear dynamics</strong>. Many of these classic models are classic because their results weren’t obvious before the model was created.
<ul>
<li>example: Lorenz model of the atmosphere which exhibits <strong>chaos</strong> (<a href="https://www.youtube.com/watch?v=FYE4JKAXSfY">video</a>). The equations for this system are simple, but Lorenz was surprised to find that the behaviour of the system could be very different for starting conditions that were very similar. I wrote a quick simulation in R which you can play around with, it’s at the bottom of these notes.</li>
<li>example: Lotka-volterra predator-prey model. This model predicts never-ending oscillations in the populations of predator and prey species. A simulation for this is also at the bottom of these notes.
<ul>
<li>What else is a reasonable thing that could happen to a population of predator and prey?</li>
</ul>
<!--Possible answers: 
- predators eat all the prey and the prey dies, then the predator dies. 
- predators and prey reach an unchanging steady-state --></li>
</ul>
<em>Aside</em>: I do theoretical biophysics, which is quite similar to theoretical ecology in my case, so all of what I’ll be telling you about is techniques and concepts that I have found useful or use very frequently and that I think are an important part of the theorist / data scientist toolkit.</li>
</ul></li>
<li>In the next two lectures we will talk about population models and about using R to analyze models. We will talk about fitting models to data, and by the end I hope that you will be able to incorporate modelling into your project, whether a model you design yourself or an existing ecological model.</li>
</ol>
</div>
<div id="setting-up-a-population-model" class="section level2">
<h2>Setting up a population model</h2>
<p>Let’s look at some examples of one-dimensional population models and talk about what we can learn from these models qualitatively, without doing any calculations.</p>
<p><strong>Dimension</strong>: the number of variables in your model. (Not the number of parameters. Variables are what track the species you’re interested in, and parameters are numbers that specify the details of the model.)</p>
<p>Let’s write down a model for the growth of a species. We want to predict how many organisms are present in the population at time <span class="math inline">\(t\)</span>, and to do that we need to write down an equation that describes how the population changes with time. We will start by writing a <em>recursion relation</em>, which tells us how to update the population size at time <span class="math inline">\(t+ \Delta t\)</span> from the population size at time <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[N_{t+\Delta t} = N_t + \Delta N\]</span></p>
<p><span class="math inline">\(\Delta N\)</span>, the change in the population size, will depend on the specifics of our model. Let’s rearrange this expression into the definition of a derivative by moving <span class="math inline">\(N_t\)</span> over and dividing both sides by <span class="math inline">\(\Delta t\)</span>, then taking the limit of <span class="math inline">\(\Delta t\)</span> going to <span class="math inline">\(0\)</span>:</p>
<p><span class="math display">\[\frac{N_{t+\Delta t} - N_t}{\Delta t} = \frac{\Delta N}{\Delta t}\]</span> <span class="math display">\[lim_{\Delta t \to 0}\frac{N_{t+\Delta t} - N_t}{\Delta t} = lim_{\Delta t \to 0}\frac{\Delta N}{\Delta t} = \frac{dN}{dt}\]</span></p>
<p>If you’ve taken calculus, you will recognize this as the first derivative of <span class="math inline">\(N\)</span> with respect to <span class="math inline">\(t\)</span>. If your calculus is foggy in your memory, when you see this notation think &quot;change in <span class="math inline">\(N\)</span> per change in <span class="math inline">\(t\)</span>. For a linear function, this is the same as the <span class="math inline">\(\beta\)</span> coefficient we talked about a few classes ago.</p>
<p><span class="math inline">\(dN\)</span> is the notation commonly used to mean “a small amount of <span class="math inline">\(N\)</span>,” so this expression mathematically describes by what small amount <span class="math inline">\(N\)</span> will change in a small amount of time <span class="math inline">\(dt\)</span>. This is also sometimes written as <span class="math inline">\(\dot{N}\)</span>. I will usually use <span class="math inline">\(dN/dt\)</span> but you may see the dot notation in the literature. A single dot is shorthand for “first derivative”.</p>
<p>Biologically, <span class="math inline">\(dN/dt\)</span> is the <strong>growth rate</strong> or <strong>rate of change</strong> of a population of <span class="math inline">\(N\)</span> organisms at time <span class="math inline">\(t\)</span>.</p>
<p>What should the growth rate of our population depend on? Let’s brainstorm some things. There are no wrong answers here: anything you can think of that makes biological sense is a reasonable thing to include in a model, although after brainstorming we will write something very simple as an example.</p>
<!-- Possible answers: 
- birth rate $r$
- death rate $\delta$
- number of organisms $N$
- carrying capacity $K$
- rate of predation
- migration rate
- abundance of food -->
<p>Let’s make some sample data to help us come up with a simple model.</p>
<p>For bacteria growing in a flask with plenty of food, we know that they divide in two periodically. If we take one unit of time to be the time between divisions, we can assume that the population approximately doubles at each time point.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(tidyverse) <span class="co"># ggplot2 includes the qplot function</span></a></code></pre></div>
<pre><code>## ── Attaching packages ────────────────────────────────── tidyverse 1.2.1 ──</code></pre>
<pre><code>## ✔ ggplot2 3.2.1     ✔ purrr   0.3.2
## ✔ tibble  2.1.3     ✔ dplyr   0.8.3
## ✔ tidyr   0.8.3     ✔ stringr 1.4.0
## ✔ readr   1.3.1     ✔ forcats 0.4.0</code></pre>
<pre><code>## ── Conflicts ───────────────────────────────────── tidyverse_conflicts() ──
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># qplot produces plots that are similar to ggplot, but you don&#39;t need a dataframe to use it.</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co"># We could use ggplot instead by first making a dataframe out of our data:</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co"># data &lt;- data.frame(times, population_size)</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">times &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dt">by =</span> <span class="fl">0.2</span>) <span class="co"># make a sequence of time points</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">population_size &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">^</span><span class="st"> </span>times <span class="co"># make a sequence for the population size: it doubles at every time point</span></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="kw">qplot</span>(times, population_size) <span class="op">+</span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="st">  </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>How do we write our population growth assumption as a general model? Let’s calculate the difference in <span class="math inline">\(N\)</span> at each time point and plot this vs. <span class="math inline">\(N\)</span> at the previous time point.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># last N-1 points minus first N-1 points</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">N_diff &lt;-<span class="st"> </span><span class="kw">tail</span>(population_size, <span class="dv">-1</span>) <span class="op">-</span><span class="st"> </span><span class="kw">head</span>(population_size, <span class="dv">-1</span>) </a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="kw">qplot</span>(<span class="kw">head</span>(population_size, <span class="dv">-1</span>), N_diff) <span class="op">+</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_line</span>()</a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>This is a straight line, which tells us that the change in <span class="math inline">\(N\)</span> is proportional to <span class="math inline">\(N\)</span>, and in fact because of the way we defined time, the change in <span class="math inline">\(N\)</span> is exactly <span class="math inline">\(N\)</span>.</p>
<p>Now we have our model: this model describes <strong>exponential</strong> growth of a population and is commonly used for microbes growing with plenty of food.</p>
<p><span class="math display">\[\frac{dN}{dt}=N\]</span></p>
<p>This is a <strong>differential equation</strong>: an equation that describes how some function of <span class="math inline">\(N\)</span> is related to derivatives of <span class="math inline">\(N\)</span>. (In this case we’ll just be using the first derivative.)</p>
<p>If we wanted time to be something else, like minutes instead of generations, we could add a constant of proportionality that captures how often our bacteria divide:</p>
<p><span class="math display">\[\frac{dN}{dt} = rN\]</span></p>
<p>This says that the population will increase by <span class="math inline">\(r N\)</span> per unit of time, or the population increases by <span class="math inline">\(N\)</span> in time <span class="math inline">\(1/r\)</span>.</p>
<p>The process we just used to get this model is probably not what you’d do in practice - I just wanted to illustrate the connection between exponential growth and this differential equation.</p>
<blockquote>
<h4 id="challenge">Challenge</h4>
<p>If <span class="math inline">\(r\)</span> is made larger, does the population grow faster or slower?</p>
</blockquote>
</div>
<div id="analyzing-models" class="section level2">
<h2>Analyzing models</h2>
<p>When you analyze a model, the exact questions you answer will depend on the model. But in general, the following questions are ones you will try to answer for any population model.</p>
<ol style="list-style-type: decimal">
<li>What are the <strong>fixed points</strong> of the model? (For which sizes of the population(s) does the population size remain constant in time?)</li>
<li>Which of the fixed points are <strong>stable</strong>? (If the population is slightly different from the fixed point, will it go towards it or away from it?)</li>
<li>How do the above depend on parameters of the model?</li>
<li>Which parameters fit my data best, and how good is the fit?</li>
</ol>
<p>We will answer the first two questions qualitatively by graphing our models. We will draw a <strong>phase portrait</strong> of this system, and the techniques we use will be applicable to almost any population model you might come across.</p>
<div id="the-exponential-growth-model" class="section level3">
<h3>The exponential growth model</h3>
<p>There’s a lot of information in the differential equation we can qualitatively read off. If we plot <span class="math inline">\(dN/dt\)</span> vs <span class="math inline">\(N\)</span>, the places where <span class="math inline">\(dN/dt = 0\)</span> are the fixed points of our system. Let’s do this for the exponential growth model.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">N_seq &lt;-</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="kw">seq</span>(<span class="op">-</span><span class="dv">20</span>, <span class="dv">20</span>) <span class="co"># make a sequence of N values to plot dN/dt against</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">dN_dt &lt;-<span class="st"> </span>N_seq  <span class="co"># assume r = 1</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw">qplot</span>(N_seq, dN_dt) <span class="op">+</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> N_seq, <span class="dt">y =</span> <span class="dv">0</span>)) <span class="co"># a line at zero for visual aid</span></a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p><span class="math inline">\(dN/dt = 0\)</span> when <span class="math inline">\(N=0\)</span>, so <span class="math inline">\(N=0\)</span> is the only fixed point for this system. We can also tell whether the fixed points are stable or unstable by looking at the sign of <span class="math inline">\(dN/dt\)</span> on either side of the fixed point. For a one-dimensional system, our phase portrait is a line of <span class="math inline">\(N\)</span>. We mark the fixed point(s) with circles, and we draw an arrow to the left wherever <span class="math inline">\(dN/dt\)</span> is negative, and an arrow to the right wherever <span class="math inline">\(dN/dt\)</span> is positive in the regions between fixed points.</p>
<!-- diagram of phase portrait -->
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>This model is a bit boring - there’s only one fixed point, and it’s unstable. This makes sense - we are talking about exponential growth, after all. There’s no upper limit.</p>
<div id="challenge-1" class="section level4">
<h4>Challenge</h4>
<p>Find the fixed point(s) of the following differential equation.</p>
<p><span class="math display">\[\frac{dN}{dt} = N - a\]</span></p>
<ul>
<li>Choose a value for the parameter <span class="math inline">\(a\)</span>. Can you think of anything that <span class="math inline">\(a\)</span> might represent in a real population? Are there any values of <span class="math inline">\(a\)</span> that don’t make biological sense?</li>
<li>Plot <span class="math inline">\(\frac{dN}{dt}\)</span> vs. <span class="math inline">\(N\)</span>, like we did earlier.</li>
<li>Sketch a phase portrait. Are the fixed point(s) stable or unstable?</li>
</ul>
</div>
</div>
<div id="the-logistic-model" class="section level3">
<h3>The logistic model</h3>
<p>Of course in real life there must be an upper limit to growth, otherwise the surface of the earth would be covered in bacteria several feet thick in a matter of hours. Let’s look at another model, the <em>logistic growth model</em>, which most of you will have seen before:</p>
<p><span class="math display">\[\frac{dN}{dt} = rN\left(1-\frac{N}{K}\right)\]</span></p>
<p><span class="math inline">\(N\)</span> is the number of organisms, <span class="math inline">\(r\)</span> is the growth rate, and <span class="math inline">\(K\)</span> is the carrying capacity of the system.</p>
<p>Notice that when <span class="math inline">\(N\)</span> is much smaller than <span class="math inline">\(K\)</span>, this reduces to the exponential growth model we just looked at since <span class="math inline">\(N/K \approx 0\)</span>.</p>
<p>Let’s again plot <span class="math inline">\(dN/dt\)</span> vs. <span class="math inline">\(N\)</span> to find the fixed points:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">N_seq &lt;-</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="st">  </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">20</span>, <span class="dv">100</span>) <span class="co"># make a sequence of N values to plot dN/dt against</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb8-4" data-line-number="4">logistic_eqn &lt;-<span class="st">  </span><span class="cf">function</span>(N, r, K) {</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  <span class="co"># calculate dN/dt for the logistic equation</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  <span class="kw">return</span>(r <span class="op">*</span><span class="st"> </span>N <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>N <span class="op">/</span><span class="st"> </span>K))</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  }</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb8-9" data-line-number="9">dN_dt &lt;-<span class="st"> </span><span class="kw">logistic_eqn</span>(N_seq, <span class="dt">r =</span> <span class="fl">0.5</span>, <span class="dt">K =</span> <span class="dv">80</span>)  <span class="co"># notice the vectorized implementation</span></a>
<a class="sourceLine" id="cb8-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb8-11" data-line-number="11"><span class="kw">qplot</span>(N_seq, dN_dt) <span class="op">+</span></a>
<a class="sourceLine" id="cb8-12" data-line-number="12"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> N_seq, <span class="dt">y =</span> <span class="dv">0</span>)) <span class="co"># a line at zero for visual aid</span></a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p>The fixed points are at <span class="math inline">\(N=0\)</span> and <span class="math inline">\(N=80\)</span>. If we change <span class="math inline">\(K\)</span>, we can figure out that the second fixed point is actually just <span class="math inline">\(N=K\)</span>.</p>
<p>Now we draw the phase portrait:</p>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<!-- Phase portrait for logistic eqn -->
<p>As with the exponential growth model, the fixed point at <span class="math inline">\(0\)</span> is unstable, but now there is also a fixed point at <span class="math inline">\(K\)</span> which is stable. This means that at longer times, the system will go towards <span class="math inline">\(N=K\)</span>.</p>
</div>
<div id="note-the-importance-of-stability" class="section level3">
<h3>Note: the importance of stability</h3>
<p>Why is stability important? The real world is noisy, and while mathematically an unstable fixed point is still a fixed point (if you were exactly there you would stay there forever), in reality there will always be small perturbations (perhaps a member of the population dies or migrates in) that will move you away from the fixed point. The important thing to know, then, is whether the population will remain close to that fixed point or move away to a different point.</p>
<p>Think of a ball balanced perfectly on top of a hill, or think of balancing a pen on your finger, or think of balancing a chair on the back two legs. It can stay there as long as there are no disturbances, but the tiniest breath of wind or tremble in your balance will knock it over and it will go towards its other fixed point - the ground.</p>
</div>
<div id="note-discrete-vs.continuous" class="section level3">
<h3>Note: discrete vs. continuous</h3>
<div id="challenge-2" class="section level4">
<h4>Challenge</h4>
<p>There is a subtlety to these differential equation descriptions of models. To see this, calculate <span class="math inline">\(\frac{dN}{dt}\)</span> for the exponential model with <span class="math inline">\(r=1\)</span> and <span class="math inline">\(N=0.1\)</span>. Is this value positive, negative, or zero? Think about what <span class="math inline">\(N=0.1\)</span> means biologically. Does it make sense that the population should increase if <span class="math inline">\(N=0.1\)</span>?</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">r &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">N &lt;-<span class="st"> </span><span class="fl">0.1</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">r<span class="op">*</span>N</a></code></pre></div>
<pre><code>## [1] 0.1</code></pre>
<p>Clearly, if <span class="math inline">\(N\)</span> represents a real population, it can only ever take integer values (it must be <em>discrete</em>), and it can never be negative. But there’s nothing in the model by itself, <span class="math inline">\(\frac{dN}{dt} = rN\)</span>, that requires any of those things. Models like this are <em>continuous</em> - the variable <span class="math inline">\(N\)</span> can be any real number and isn’t restricted to integers.</p>
<p>How do we reconcile this with the real world? For “large” population sizes, the continuous description is fairly accurate, since if <span class="math inline">\(N\)</span> is, say, 400, then a change of <span class="math inline">\(\pm 1\)</span> is a relatively small change, and we can think of <span class="math inline">\(N\)</span> as varying continuously. But for small populations, the continuous description breaks down. If <span class="math inline">\(N\)</span> falls below <span class="math inline">\(1\)</span>, the continuous description might tell you that it can bounce back, but in reality <span class="math inline">\(N&lt;1\)</span> means the population is extinct. Even though <span class="math inline">\(N=0\)</span> was an unstable fixed point for the systems we looked at so far, it’s what is called an <strong>absorbing</strong> state: once you enter it, you can never leave (unless we add something back in, of course).</p>
<p>There is a way to model the discreteness of a population so that small population sizes are treated realistically - it’s called “stochastic simulation” and the most common method is to use the Gillespie algorithm.</p>
</div>
</div>
</div>
<div id="recap-and-some-tips" class="section level2">
<h2>Recap and some tips</h2>
<ul>
<li><p>You can include math in R notebooks using <a href="https://en.wikibooks.org/wiki/LaTeX/Mathematics">LaTeX syntax</a>.</p>
<p><code>$$\frac{dN}{dt} = r N (1 - N/K)$$</code> produces <span class="math display">\[\frac{dN}{dt} = r N (1 - N/K)\]</span></p></li>
<li><p><strong>Differential equation</strong>: an equation that describes how a function of variables is related to derivatives of those variables.</p></li>
<li><p>Drawing <strong>phase portraits</strong> in one dimension:</p>
<div class="figure">
<img src="image/logistic.gif" alt="Logistic equation simulation" />
<p class="caption">Logistic equation simulation</p>
</div>
<ul>
<li>Fixed points: values of <span class="math inline">\(N\)</span> at which <span class="math inline">\(\frac{dN}{dt}\)</span>, the rate of change of <span class="math inline">\(N\)</span>, is <span class="math inline">\(0\)</span>. To find fixed points, plot <span class="math inline">\(\frac{dN}{dt}\)</span> vs. <span class="math inline">\(N\)</span> and find the place(s) where it crosses the <span class="math inline">\(x\)</span> axis.</li>
<li>Stability: if you start at some <span class="math inline">\(N\)</span> close to the fixed point but not exactly on it, will you go towards (stable) or away (unstable) from the fixed point? The sign of <span class="math inline">\(\frac{dN}{dt}\)</span> on either side of a fixed point tells you whether <span class="math inline">\(N\)</span> will increase or decrease in that area. Draw an arrow to the right if <span class="math inline">\(\frac{dN}{dt}\)</span> is positive, and draw an arrow to the left if <span class="math inline">\(\frac{dN}{dt}\)</span> is negative.</li>
</ul></li>
</ul>
<div id="challenge-3" class="section level4">
<h4>Challenge</h4>
<p>Find the fixed point(s) of the following differential equation.</p>
<p><span class="math display">\[\frac{dN}{dt} = \text{sin}(N)\]</span></p>
<ul>
<li>Plot <span class="math inline">\(\frac{dN}{dt}\)</span> vs. <span class="math inline">\(N\)</span> for <span class="math inline">\(N\)</span> ranging from <span class="math inline">\(0\)</span> to <span class="math inline">\(10\)</span>.</li>
<li>Sketch a phase portrait on paper. Are the fixed point(s) stable or unstable?</li>
</ul>
<p>You can think of <span class="math inline">\(dN/dt\)</span> as a <em>velocity</em>: it tells you how fast <span class="math inline">\(N\)</span> is changing and in what direction. If we start a <strong>trajectory</strong> at some initial <span class="math inline">\(N_0\)</span>, <span class="math inline">\(dN/dt\)</span> dictates whether <span class="math inline">\(N\)</span> will increase, decrease, or stay the same. If <span class="math inline">\(N_0\)</span> happens to be at a fixed point, <span class="math inline">\(N\)</span> will remain at <span class="math inline">\(N_0\)</span> for all time.</p>
</div>
</div>
<div id="numerically-simulating-models-in-r" class="section level2">
<h2>Numerically simulating models in R</h2>
<p>Some differential equations are possible to solve analytically (by integration). But when we encounter equations that are hard to solve analytically, we can instead solve them <strong>numerically</strong>. Numerically solving a differential equation means calculating an approximate solution for the variable of interest as it evolves in time, using the information contained in the equation about the <em>rate of change</em> of the variable at each time point.</p>
<p>Let’s use the logistic equation as an example again, plotting <span class="math inline">\(dN/dt\)</span> vs. <span class="math inline">\(N\)</span>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">N_seq &lt;-</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="st">  </span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">20</span>, <span class="dv">100</span>) <span class="co"># make a sequence of N values to plot dN/dt against</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb11-4" data-line-number="4">dN_dt &lt;-<span class="st"> </span><span class="kw">logistic_eqn</span>(N_seq, <span class="dt">r =</span> <span class="fl">0.5</span>, <span class="dt">K =</span> <span class="dv">80</span>)  <span class="co"># use the logistic equation function we defined before</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="kw">qplot</span>(N_seq, dN_dt) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> N_seq, <span class="dt">y =</span> <span class="dv">0</span>)) <span class="co"># a line at zero for visual aid</span></a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p><span class="math inline">\(dN/dt\)</span> is the <strong>slope</strong> of <span class="math inline">\(N\)</span> with respect to <span class="math inline">\(t\)</span> at a given value of <span class="math inline">\(N\)</span>. We can use the slope as an update rule, exactly like the recursion equation we wrote earlier that in the limit became a derivative:</p>
<p><span class="math display">\[lim_{\Delta t \to 0}\frac{N_{t+\Delta t} - N_t}{\Delta t} = \frac{dN}{dt}\]</span></p>
<p>Given a starting point <span class="math inline">\(N_t\)</span>, we can <em>approximate</em> <span class="math inline">\(N_{t+\Delta t}\)</span> using the differential equation:</p>
<p><span class="math display">\[\frac{N_{t+\Delta t} - N_t}{\Delta t} \approx \frac{dN}{dt} \]</span></p>
<p><span class="math display">\[N_{t+\Delta t} \approx N_t + \frac{dN}{dt} \Delta t\]</span></p>
<p>To generate a solution for <span class="math inline">\(N\)</span> as it varies with <span class="math inline">\(t\)</span>, we loop through the recursion relation above, updating <span class="math inline">\(N\)</span> at each timestep.</p>
<p>The image below is a cartoon of what this looks like in practice. Starting from a point <span class="math inline">\(A_0\)</span>, we use the derivative to tell us in what direction we should take our next step. <span class="math inline">\(\Delta t\)</span> is a parameter we can choose that determines how large of a step we take.</p>
<p>This process has several names: <strong>Euler’s method</strong> after Leonhard Euler who wrote about it in about 1770, or <strong>forward finite difference method</strong>, referring to the process of stepping forward in time in small (<em>finite</em>) increments (<em>difference</em>).</p>
<div class="figure">
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/10/Euler_method.svg/412px-Euler_method.svg.png" alt="Euler’s method: blue is the true solution, red is the approximate solution. Image source: Wikimedia" />
<p class="caption">Euler’s method: blue is the true solution, red is the approximate solution. Image source: Wikimedia</p>
</div>
<p>There are many related but slightly different techniques for numerically solving differential equations. The best method will often depend on the situation, and we won’t go into detail on any other methods, but you can look up <a href="https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods"><em>Runge-Kutta</em> methods</a> if you’re interested in learning more about it.</p>
<p>R has a package for numerically solving differential equations called <code>deSolve</code>. You could also implement Euler’s method yourself; an example of how to do this is at the end of today’s notes.</p>
<div id="eulers-method-on-paper" class="section level3">
<h3>Euler’s method on paper</h3>
<p>We will calculate numerical solutions for the logistic equation so that we can compare what we know about the fixed points and their stability with the way a population obeying this equation changes in time. We’ll start with a paper example, then later implement it in R with <code>deSolve</code>.</p>
<p>This is the update rule:</p>
<p><span class="math display">\[N_{t+\Delta t} = N_t + \frac{dN}{dt} \Delta t\]</span></p>
<p>To calculate a solution which consists of some values of <span class="math inline">\(N\)</span> at particular times <span class="math inline">\(t\)</span>, we need to choose a population size to start at (<span class="math inline">\(N_0\)</span>), values for the parameters, and a timestep size (<span class="math inline">\(\Delta t\)</span>).</p>
<p>Let’s choose <span class="math inline">\(r = 1\)</span>, <span class="math inline">\(K = 10\)</span>, <span class="math inline">\(N_0 = 2\)</span>, and <span class="math inline">\(\Delta t = 1\)</span> to make our math easier.</p>
<p>Now we have <span class="math inline">\(N_{t=0} = N_0 = 2\)</span>, and we want <span class="math inline">\(N_{t=0+ \Delta t} = N_{t=0 +1} = N_1\)</span>. We apply the update rule:</p>
<p><span class="math display">\[N_1 = \frac{dN}{dt} \Delta t + N_0\]</span></p>
<p><span class="math display">\[N_1 = \frac{dN}{dt} \times 1 + N_0\]</span></p>
<p><span class="math display">\[N_1 = \frac{dN}{dt} + N_0\]</span></p>
<p>What should we put in for <span class="math inline">\(dN/dt\)</span>? We know <span class="math inline">\(dN/dt\)</span> for the logistic equation is</p>
<p><span class="math display">\[\frac{dN}{dt} = rN(1-\frac{N}{K})\]</span></p>
<p>We’ve chosen <span class="math inline">\(r\)</span> and <span class="math inline">\(K\)</span>, but what value should we put in for <span class="math inline">\(N\)</span>?</p>
<p>This is not obvious at all, and there’s really no one right answer. There are other related methods of numerically solving differential equations that choose a value of <span class="math inline">\(N\)</span> halfway between <span class="math inline">\(N_0\)</span> and <span class="math inline">\(N_1\)</span> (the <strong>midpoint method</strong>), or you could use <span class="math inline">\(N_1\)</span>. But the simplest thing to do is to use <span class="math inline">\(N_0\)</span>, because we don’t yet know <span class="math inline">\(N_1\)</span> and it’s slightly more complicated to use an <span class="math inline">\(N\)</span> that depends on <span class="math inline">\(N_1\)</span>. This is the process shown in the cartoon above — we use the slope of <span class="math inline">\(N\)</span> at the point <span class="math inline">\(N_0\)</span> to tell us where <span class="math inline">\(N\)</span> should be at the next timestep.</p>
<p>If we put in <span class="math inline">\(N_0\)</span> to <span class="math inline">\(dN/dt\)</span>:</p>
<p><span class="math display">\[N_1 = rN_0(1-\frac{N_0}{K}) + N_0\]</span></p>
<p>Now we have a thing we can calculate! Plugging in the numbers we chose for <span class="math inline">\(r\)</span>, <span class="math inline">\(K\)</span>, and <span class="math inline">\(N_0\)</span>, we get</p>
<p><span class="math display">\[N_1 = 1 \times 2(1-\frac{2}{10}) + 2\]</span> <span class="math display">\[N_1 =  2+ 1.6 = 3.6\]</span> We repeat the proccess to get <span class="math inline">\(N_2\)</span>, and so on, remembering to evaluate <span class="math inline">\(dN/dt\)</span> at the value of <span class="math inline">\(N\)</span> from the previous timestep. The vertical bar <span class="math inline">\(\vert\)</span> instructs us to substitute <span class="math inline">\(N_0\)</span> for <span class="math inline">\(N\)</span> in the derivative.</p>
<p><span class="math display">\[N_2 = \frac{dN}{dt}\vert_{N = N_1} + N_1\]</span></p>
<p><span class="math display">\[N_2 = rN_1(1-\frac{N_1}{K}) + N_1\]</span></p>
<p><span class="math display">\[N_2 = 2.304 + 3.6 = 5.904\]</span></p>
<p>In 1770 there were no computers. It’s really amazing that people were using these numerical techniques long before computers existed to automate the process. According to Wikipedia, it was partly the push to develop faster and better ways to numerically solve differential equations that led to the computer as we know it.</p>
<p>Lorenz simulated his famous equations on one of the earliest computers in 1960, and this was how he discovered the chaotic behaviour of the model.</p>
<p>In the movie <em>Hidden Figures</em>, Katherine Goble Johnson uses Euler’s method to numerically match the equations for hyperbolic and elliptical orbit to get the astronaut John Glenn back from space. Watch the scene <a href="https://www.youtube.com/watch?v=v-pbGAts_Fg">here</a>.</p>
</div>
</div>
<div id="using-desolve-in-r-to-solve-differential-equations-numerically" class="section level2">
<h2>Using <code>deSolve</code> in R to solve differential equations numerically</h2>
<p>R has a package called <code>deSolve</code> which contains several functions to numerically solve differential equations. Let’s look at the documentation for <code>deSolve</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">library</span>(deSolve)</a></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">?deSolve</a></code></pre></div>
<p>This is pretty hard to read, especially if your calculus was a long time ago. The important thing to know for our purposes is that the equations we’re working with are <strong>first-order ordinary differential equations</strong>. <em>First-order</em> means that the derivatives are all first derivatives (as opposed to second derivatives, third derivatives, etc.). <strong>Ordinary</strong> means that the derivatives are full derivatives (as opposed to partial derivatives which are written <span class="math inline">\(\partial N / \partial t\)</span>).</p>
<p>This means that the function we’ll be using is called <code>ode</code>, which stands for ‘ordinary differential equation’.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">?ode</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="co"># The possible methods are all different ways of numerically solving DEs.</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="co"># stiff vs. non-stiff : no precise definition, but &#39;stiff&#39; generally means it&#39;s possible to be numerically unstable if the step size is too big. </span></a></code></pre></div>
<p>The method used by <code>ode</code> to numerically solve differential equations is called <code>lsoda</code>, which automatically tries to use the best method depending on the equation. This is why people like to use functions like <code>ode</code>: the result is often more accurate than Euler’s method and might also be faster to run.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># Example: deSolve with logistic eqn</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="co"># now we need to define our function a bit differently to be in the format that `ode` uses</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">logistic_fn &lt;-<span class="st"> </span><span class="cf">function</span>(t, state, parameters) {</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">  <span class="co"># Calculates dN/dt for the logistic equation</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb15-7" data-line-number="7">  <span class="co"># t: time point at which to evaluate derivative (doesn&#39;t actually change anything in this example)</span></a>
<a class="sourceLine" id="cb15-8" data-line-number="8">  <span class="co"># state: vector of variables (here it&#39;s just N)</span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9">  <span class="co"># parameters: vector of model parameters c(r, K)</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb15-11" data-line-number="11">  N &lt;-<span class="st"> </span>state </a>
<a class="sourceLine" id="cb15-12" data-line-number="12">  </a>
<a class="sourceLine" id="cb15-13" data-line-number="13">  r &lt;-<span class="st"> </span>parameters[<span class="dv">1</span>] <span class="co"># the first element of the parameters vector is r</span></a>
<a class="sourceLine" id="cb15-14" data-line-number="14">  K &lt;-<span class="st"> </span>parameters[<span class="dv">2</span>] <span class="co"># the second element of the parameters vector is K</span></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"></a>
<a class="sourceLine" id="cb15-16" data-line-number="16">  <span class="co">#rate of change</span></a>
<a class="sourceLine" id="cb15-17" data-line-number="17">  dN &lt;-<span class="st"> </span>r <span class="op">*</span><span class="st"> </span>N <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>N <span class="op">/</span><span class="st"> </span>K)</a>
<a class="sourceLine" id="cb15-18" data-line-number="18">    </a>
<a class="sourceLine" id="cb15-19" data-line-number="19">  <span class="co">#return rate of change</span></a>
<a class="sourceLine" id="cb15-20" data-line-number="20">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="kw">c</span>(dN)))</a>
<a class="sourceLine" id="cb15-21" data-line-number="21">}</a>
<a class="sourceLine" id="cb15-22" data-line-number="22"></a>
<a class="sourceLine" id="cb15-23" data-line-number="23">parameters &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">r =</span> <span class="fl">0.5</span>, <span class="dt">K =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb15-24" data-line-number="24">state &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">N =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb15-25" data-line-number="25">times &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dt">by =</span> <span class="fl">0.01</span>) <span class="co"># the timestep dt is chosen by setting the increment with &#39;by&#39;</span></a>
<a class="sourceLine" id="cb15-26" data-line-number="26"></a>
<a class="sourceLine" id="cb15-27" data-line-number="27"><span class="co">#?ode # look at the documentation to learn about the parameters</span></a>
<a class="sourceLine" id="cb15-28" data-line-number="28">result &lt;-<span class="st"> </span><span class="kw">ode</span>(<span class="dt">y =</span> state, <span class="dt">times =</span> times, <span class="dt">func =</span> logistic_fn, <span class="dt">parms =</span> parameters)</a></code></pre></div>
<p>The output of <code>ode</code> is a matrix that contains the times we requested and its calculated values of N.</p>
<p>Notice that by using <code>ode</code> we didn’t have to write a loop explicitly ourselves. Under the hood, <code>ode</code> performs a similar computation to what we did manually.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="kw">head</span>(result, <span class="dv">5</span>) <span class="co"># result has a list of times and values of N at those times</span></a></code></pre></div>
<pre><code>##      time        N
## [1,] 0.00 10.00000
## [2,] 0.01 10.04006
## [3,] 0.02 10.08024
## [4,] 0.03 10.12054
## [5,] 0.04 10.16096</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">class</span>(result) <span class="co"># result is a &#39;matrix&#39;: an array of numbers</span></a></code></pre></div>
<pre><code>## [1] &quot;deSolve&quot; &quot;matrix&quot;</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">result &lt;-<span class="st"> </span><span class="kw">data.frame</span>(result) <span class="co"># convert it to a dataframe so we can use ggplot</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="kw">ggplot</span>(result) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> N))</a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<div id="challenge---in-groups" class="section level4">
<h4>Challenge - in groups</h4>
<p>Use <code>deSolve</code> to calculate a numerical solution for the following differential equation:</p>
<p><span class="math display">\[\frac{dx}{dt} = -2.3 x\]</span></p>
<p>The exact solution is</p>
<p><span class="math display">\[x(t) = x_0 \text{e}^{-2.3t}\]</span></p>
<p>Use an initial condition of <span class="math inline">\(x_0 = 50\)</span>, and calculate your answer for <span class="math inline">\(t\)</span> from <span class="math inline">\(0\)</span> to <span class="math inline">\(10\)</span>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="co"># challenge solution</span></a>
<a class="sourceLine" id="cb21-2" data-line-number="2"></a>
<a class="sourceLine" id="cb21-3" data-line-number="3">dx_dt &lt;-<span class="st"> </span><span class="cf">function</span>(t, state, parameters) {</a>
<a class="sourceLine" id="cb21-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb21-5" data-line-number="5">  x &lt;-<span class="st"> </span>state</a>
<a class="sourceLine" id="cb21-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb21-7" data-line-number="7">  dx &lt;-<span class="st"> </span><span class="fl">-2.3</span> <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb21-8" data-line-number="8">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="kw">c</span>(dx)))</a>
<a class="sourceLine" id="cb21-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb21-10" data-line-number="10"></a>
<a class="sourceLine" id="cb21-11" data-line-number="11">state &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">x =</span> <span class="dv">50</span>)</a>
<a class="sourceLine" id="cb21-12" data-line-number="12">times &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dt">by =</span> <span class="fl">0.1</span>)</a>
<a class="sourceLine" id="cb21-13" data-line-number="13"></a>
<a class="sourceLine" id="cb21-14" data-line-number="14">result &lt;-<span class="st"> </span><span class="kw">ode</span>(<span class="dt">y =</span> state, <span class="dt">times =</span> times, <span class="dt">func =</span> dx_dt)</a>
<a class="sourceLine" id="cb21-15" data-line-number="15">result &lt;-<span class="st"> </span><span class="kw">data.frame</span>(result)</a>
<a class="sourceLine" id="cb21-16" data-line-number="16"><span class="kw">head</span>(result)</a></code></pre></div>
<pre><code>##   time        x
## 1  0.0 50.00000
## 2  0.1 39.72673
## 3  0.2 31.56421
## 4  0.3 25.07881
## 5  0.4 19.92595
## 6  0.5 15.83188</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="co"># plot the result</span></a>
<a class="sourceLine" id="cb23-2" data-line-number="2"><span class="kw">ggplot</span>(result) <span class="op">+</span></a>
<a class="sourceLine" id="cb23-3" data-line-number="3"><span class="st">  </span><span class="kw">geom_point</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> x)) <span class="op">+</span></a>
<a class="sourceLine" id="cb23-4" data-line-number="4"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> times, <span class="dt">y =</span> <span class="dv">50</span><span class="op">*</span><span class="kw">exp</span>(<span class="op">-</span><span class="fl">2.3</span><span class="op">*</span>times))) <span class="co"># add the exact solution</span></a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-16-1.png" width="672" /></p>
</div>
</div>
<div id="extras" class="section level2">
<h2>Extras</h2>
<div id="eulers-method-in-r" class="section level3">
<h3>Euler’s method in R</h3>
<p>Let’s review <code>for loops</code> first. A loop is a method to do something over and over again, which is perfect for Euler’s method — on paper, we were performing the same calculation over and over with a different value of <span class="math inline">\(N\)</span> each time.</p>
<p>Here’s an example from an earlier lecture:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="co"># For each number in v, print the number.</span></a>
<a class="sourceLine" id="cb24-2" data-line-number="2">v &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb24-3" data-line-number="3"><span class="cf">for</span> (num <span class="cf">in</span> v) {</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">    <span class="kw">print</span>(num)</a>
<a class="sourceLine" id="cb24-5" data-line-number="5">}</a></code></pre></div>
<pre><code>## [1] 2
## [1] 4
## [1] 6</code></pre>
<p>Now let’s build up our Euler’s method code in R.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="co"># Numerically solve the logistic equation using Euler&#39;s method</span></a>
<a class="sourceLine" id="cb26-2" data-line-number="2"></a>
<a class="sourceLine" id="cb26-3" data-line-number="3"><span class="co"># We have a function `logistic_eqn` that we defined before, so we can use that one.</span></a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="co"># We don&#39;t need to re-write it here if the previous chunk has been executed, but we can.</span></a>
<a class="sourceLine" id="cb26-5" data-line-number="5"></a>
<a class="sourceLine" id="cb26-6" data-line-number="6">logistic_eqn &lt;-<span class="st">  </span><span class="cf">function</span>(N, r, K) {</a>
<a class="sourceLine" id="cb26-7" data-line-number="7">  <span class="co"># calculate dN/dt for the logistic equation</span></a>
<a class="sourceLine" id="cb26-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb26-9" data-line-number="9">  <span class="co"># r: growth rate (divisions per hour) </span></a>
<a class="sourceLine" id="cb26-10" data-line-number="10">  <span class="co"># K: carrying capacity</span></a>
<a class="sourceLine" id="cb26-11" data-line-number="11">  <span class="co"># N: population size</span></a>
<a class="sourceLine" id="cb26-12" data-line-number="12">  <span class="kw">return</span>(r <span class="op">*</span><span class="st"> </span>N <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span> <span class="op">-</span><span class="st"> </span>N <span class="op">/</span><span class="st"> </span>K))</a>
<a class="sourceLine" id="cb26-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb26-14" data-line-number="14"></a>
<a class="sourceLine" id="cb26-15" data-line-number="15"><span class="co"># parameters</span></a>
<a class="sourceLine" id="cb26-16" data-line-number="16">K &lt;-<span class="st"> </span><span class="dv">150</span></a>
<a class="sourceLine" id="cb26-17" data-line-number="17">r &lt;-<span class="st"> </span><span class="dv">1</span>  </a>
<a class="sourceLine" id="cb26-18" data-line-number="18"></a>
<a class="sourceLine" id="cb26-19" data-line-number="19">dt &lt;-<span class="st"> </span><span class="fl">0.05</span> <span class="co"># timestep - the smaller, the better</span></a>
<a class="sourceLine" id="cb26-20" data-line-number="20">tmax &lt;-<span class="st"> </span><span class="dv">8</span> <span class="co"># the total time we want to numerically solve for</span></a>
<a class="sourceLine" id="cb26-21" data-line-number="21">points &lt;-<span class="st"> </span>tmax<span class="op">/</span>dt <span class="co"># the number of data points in the simulation - add 1 so that we can start at t=0</span></a>
<a class="sourceLine" id="cb26-22" data-line-number="22"></a>
<a class="sourceLine" id="cb26-23" data-line-number="23"><span class="co"># vectors to store values of N and t at each timestep:</span></a>
<a class="sourceLine" id="cb26-24" data-line-number="24">N_vector &lt;-<span class="st"> </span><span class="kw">numeric</span>(points) <span class="co"># population size</span></a>
<a class="sourceLine" id="cb26-25" data-line-number="25">t_vector &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, tmax <span class="op">-</span><span class="st"> </span>dt, <span class="dt">by =</span> dt) <span class="co"># time vector</span></a>
<a class="sourceLine" id="cb26-26" data-line-number="26"></a>
<a class="sourceLine" id="cb26-27" data-line-number="27"><span class="co"># initial condition</span></a>
<a class="sourceLine" id="cb26-28" data-line-number="28">N0 &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb26-29" data-line-number="29">N_vector[<span class="dv">1</span>] &lt;-<span class="st"> </span>N0</a>
<a class="sourceLine" id="cb26-30" data-line-number="30"></a>
<a class="sourceLine" id="cb26-31" data-line-number="31">N &lt;-<span class="st"> </span>N0 <span class="co"># initialize variable N</span></a>
<a class="sourceLine" id="cb26-32" data-line-number="32"></a>
<a class="sourceLine" id="cb26-33" data-line-number="33"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>points) {</a>
<a class="sourceLine" id="cb26-34" data-line-number="34">  <span class="co"># start at 2 because the initial state is at position 1</span></a>
<a class="sourceLine" id="cb26-35" data-line-number="35">  dN &lt;-<span class="st"> </span><span class="kw">logistic_eqn</span>(<span class="dt">N =</span> N, <span class="dt">r =</span> r, <span class="dt">K =</span> K) <span class="op">*</span><span class="st"> </span>dt</a>
<a class="sourceLine" id="cb26-36" data-line-number="36">  N &lt;-<span class="st"> </span>N <span class="op">+</span><span class="st"> </span>dN <span class="co"># the variable N is changing at each step of the loop</span></a>
<a class="sourceLine" id="cb26-37" data-line-number="37">  N_vector[i] &lt;-<span class="st"> </span>N</a>
<a class="sourceLine" id="cb26-38" data-line-number="38">}</a>
<a class="sourceLine" id="cb26-39" data-line-number="39"></a>
<a class="sourceLine" id="cb26-40" data-line-number="40"><span class="kw">qplot</span>(t_vector, N_vector,</a>
<a class="sourceLine" id="cb26-41" data-line-number="41">      <span class="dt">ylab =</span> <span class="st">&quot;Population size N&quot;</span>,</a>
<a class="sourceLine" id="cb26-42" data-line-number="42">      <span class="dt">xlab =</span> <span class="st">&quot;Time t&quot;</span>) </a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<p>This numerical solution shows us that the population size grows until it reaches the carrying capacity <span class="math inline">\(K\)</span>, the stable fixed point.</p>
</div>
<div id="a-note-on-why-delta-t-has-to-be-small" class="section level3">
<h3>A note on why <span class="math inline">\(\Delta t\)</span> has to be small</h3>
<p>If you’re numerically solving a differential equation with Euler’s method, <span class="math inline">\(\Delta t\)</span> must be ‘small’. How small is small, and why does it have to be small? The answers to these are related, and to see why, let’s look at what can happen if <span class="math inline">\(\Delta t\)</span> is too big with an example from the logistic equation.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="co"># what happens if we make dt too large when simulating? </span></a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="co"># in this example, the starting population N0 is much larger than the carrying capacity.</span></a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="co"># This means dN/dt will be a large negative number: N will decrease quickly from such a large size.</span></a>
<a class="sourceLine" id="cb27-4" data-line-number="4"></a>
<a class="sourceLine" id="cb27-5" data-line-number="5">r &lt;-<span class="st"> </span><span class="fl">0.5</span></a>
<a class="sourceLine" id="cb27-6" data-line-number="6">K &lt;-<span class="st"> </span><span class="dv">50</span></a>
<a class="sourceLine" id="cb27-7" data-line-number="7">dt &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb27-8" data-line-number="8">N0 &lt;-<span class="st"> </span><span class="dv">400</span></a>
<a class="sourceLine" id="cb27-9" data-line-number="9"></a>
<a class="sourceLine" id="cb27-10" data-line-number="10">dN &lt;-<span class="st"> </span><span class="kw">logistic_eqn</span>(N0, r, K) <span class="op">*</span><span class="st"> </span>dt <span class="co"># this is the change in N that we wil add to N0 to calculate N1</span></a>
<a class="sourceLine" id="cb27-11" data-line-number="11"></a>
<a class="sourceLine" id="cb27-12" data-line-number="12">N1 &lt;-<span class="st"> </span>N0 <span class="op">+</span><span class="st"> </span>dN</a>
<a class="sourceLine" id="cb27-13" data-line-number="13"></a>
<a class="sourceLine" id="cb27-14" data-line-number="14"><span class="kw">print</span>(N1) <span class="co"># this is no good: N has shot from +400 to -1000 in a single step! </span></a></code></pre></div>
<pre><code>## [1] -1000</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">dN &lt;-<span class="st"> </span><span class="kw">logistic_eqn</span>(N1, r, K) <span class="op">*</span><span class="st"> </span>dt <span class="co"># calculate what the next change in N would be</span></a>
<a class="sourceLine" id="cb29-2" data-line-number="2"></a>
<a class="sourceLine" id="cb29-3" data-line-number="3">N2 &lt;-<span class="st"> </span>N1 <span class="op">+</span><span class="st"> </span>dN</a>
<a class="sourceLine" id="cb29-4" data-line-number="4"></a>
<a class="sourceLine" id="cb29-5" data-line-number="5"><span class="kw">print</span>(N2) <span class="co"># N is getting more and more negative!</span></a></code></pre></div>
<pre><code>## [1] -11500</code></pre>
<p>This is what’s called <strong>numerical instability</strong> — the numerical solution grows very large (either positive or negative) but the true solution doesn’t. In the logistic equation example above, while the true solution does grow more negative if <span class="math inline">\(N &lt; 0\)</span>, we get a trajectory that doesn’t make sense if we use a step size that’s too large.</p>
<p>For accuracy, <span class="math inline">\(\Delta t\)</span> should be small. But the smaller it is, the longer it will take to compute the numerical approximation. In practice, choose a <span class="math inline">\(\Delta t\)</span> that is small enough that your solution doesn’t behave strangely, but large enough that you can simulate it in a reasonable amount of time.</p>
</div>
<div id="qualitative-analysis-of-2d-models" class="section level3">
<h3>Qualitative analysis of 2D models</h3>
<p><strong>Two-dimensional</strong> means that there are now two variables in the system (like <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, prey and predators) instead of one (like <span class="math inline">\(N\)</span>).</p>
<p>Many of the concepts and tools from analyzing one-dimensional models will be used here as well, but we will add some things that are specific to more than one dimension.</p>
<p>To motivate some of these new concepts and the idea of modelling in two dimensions, let’s analyze a model of two species interacting.</p>
<p><span class="math display">\[\frac{dx}{dt} = ax - bxy\]</span> <span class="math display">\[\frac{dy}{dt} = cx - dy\]</span></p>
<p>This is very close to the Lotka-Volterra predator-prey model, but the term for predator growth is <span class="math inline">\(cx\)</span> instead of <span class="math inline">\(cxy\)</span>. In this model the predators will eat the prey at a constant rate, no matter how many of the predators there are.</p>
<p>First, we’ll simulate a trajectory for the two species.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1">predator_prey &lt;-<span class="st"> </span><span class="cf">function</span>(t, y, parameters) {</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">  <span class="co"># calculates dx/dt and dy/dt for a predator-prey model</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb31-4" data-line-number="4">  <span class="co"># t: time at which to evaluate derivatives</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5">  <span class="co"># y: vector of system variables (c(X, Y))</span></a>
<a class="sourceLine" id="cb31-6" data-line-number="6">  <span class="co"># parameters: vector of model parameters (c(a, b, c, d))</span></a>
<a class="sourceLine" id="cb31-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb31-8" data-line-number="8">  <span class="co"># the arguments need to be named &quot;t&quot;, &quot;y&quot;, and &quot;parameters&quot;, otherwise this won&#39;t work with phaseR, a package we will use later</span></a>
<a class="sourceLine" id="cb31-9" data-line-number="9">    </a>
<a class="sourceLine" id="cb31-10" data-line-number="10">  <span class="co">#now the state vector y has two elements because we have two species</span></a>
<a class="sourceLine" id="cb31-11" data-line-number="11">  X &lt;-<span class="st"> </span>y[<span class="dv">1</span>] <span class="co"># prey</span></a>
<a class="sourceLine" id="cb31-12" data-line-number="12">  Y &lt;-<span class="st"> </span>y[<span class="dv">2</span>] <span class="co"># predators</span></a>
<a class="sourceLine" id="cb31-13" data-line-number="13">  </a>
<a class="sourceLine" id="cb31-14" data-line-number="14">  a &lt;-<span class="st"> </span>parameters[<span class="st">&#39;a&#39;</span>]</a>
<a class="sourceLine" id="cb31-15" data-line-number="15">  b &lt;-<span class="st"> </span>parameters[<span class="st">&#39;b&#39;</span>]</a>
<a class="sourceLine" id="cb31-16" data-line-number="16">  c &lt;-<span class="st"> </span>parameters[<span class="st">&#39;c&#39;</span>]</a>
<a class="sourceLine" id="cb31-17" data-line-number="17">  d &lt;-<span class="st"> </span>parameters[<span class="st">&#39;d&#39;</span>]</a>
<a class="sourceLine" id="cb31-18" data-line-number="18">    </a>
<a class="sourceLine" id="cb31-19" data-line-number="19">  <span class="co"># calculate rate of change</span></a>
<a class="sourceLine" id="cb31-20" data-line-number="20">  dx &lt;-<span class="st"> </span>a <span class="op">*</span><span class="st"> </span>X <span class="op">-</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>Y <span class="op">*</span><span class="st"> </span>X</a>
<a class="sourceLine" id="cb31-21" data-line-number="21">  dy &lt;-<span class="st"> </span>c <span class="op">*</span><span class="st"> </span>X <span class="op">-</span><span class="st"> </span>d <span class="op">*</span><span class="st"> </span>Y</a>
<a class="sourceLine" id="cb31-22" data-line-number="22">  </a>
<a class="sourceLine" id="cb31-23" data-line-number="23">  <span class="co"># return rate of change</span></a>
<a class="sourceLine" id="cb31-24" data-line-number="24">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="kw">c</span>(dx, dy)))</a>
<a class="sourceLine" id="cb31-25" data-line-number="25">}</a></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="co"># run the numerical solution</span></a>
<a class="sourceLine" id="cb32-2" data-line-number="2"></a>
<a class="sourceLine" id="cb32-3" data-line-number="3">parameters =<span class="st"> </span><span class="kw">c</span>(<span class="dt">a =</span> <span class="dv">5</span>, <span class="dt">b =</span> <span class="dv">1</span>, <span class="dt">c =</span> <span class="dv">1</span>, <span class="dt">d =</span> <span class="fl">0.2</span>) <span class="co"># parameters named so that we can access them by name</span></a>
<a class="sourceLine" id="cb32-4" data-line-number="4">state &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">X =</span> <span class="dv">2</span>, <span class="dt">Y =</span> <span class="dv">2</span>) <span class="co"># same thing here</span></a>
<a class="sourceLine" id="cb32-5" data-line-number="5">times &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dt">by =</span> <span class="fl">0.01</span>)</a>
<a class="sourceLine" id="cb32-6" data-line-number="6"></a>
<a class="sourceLine" id="cb32-7" data-line-number="7">result &lt;-<span class="st"> </span><span class="kw">ode</span>(<span class="dt">y =</span> state, <span class="dt">times =</span> times, <span class="dt">func =</span> predator_prey, <span class="dt">parms =</span> parameters)</a>
<a class="sourceLine" id="cb32-8" data-line-number="8">result &lt;-<span class="st"> </span><span class="kw">data.frame</span>(result)</a></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="co"># plot the results</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2"></a>
<a class="sourceLine" id="cb33-3" data-line-number="3">result <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb33-4" data-line-number="4"><span class="st">  </span><span class="kw">ggplot</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb33-5" data-line-number="5"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> X), <span class="dt">color =</span> <span class="st">&#39;red&#39;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb33-6" data-line-number="6"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> Y), <span class="dt">color =</span> <span class="st">&#39;blue&#39;</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb33-7" data-line-number="7"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Population size&quot;</span>)</a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>It looks like we have oscillations that decay to a fixed point. Notice that the prey population (in red) dips below <span class="math inline">\(1\)</span> during each oscillation. If this was a real population, the prey would have gone extinct on the first dip below <span class="math inline">\(1\)</span>. This means that the parameters we’ve chosen aren’t very realistic. We could instead choose parameters that would change the fixed points to real-world population sizes.</p>
<p>We can modify the plotting code above to include a legend distinguishing ‘predators’ and ‘prey’.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="co"># Challenge solution</span></a>
<a class="sourceLine" id="cb34-2" data-line-number="2"></a>
<a class="sourceLine" id="cb34-3" data-line-number="3">result <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-4" data-line-number="4"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">Prey =</span> X, <span class="dt">Predator =</span> Y) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb34-5" data-line-number="5"><span class="st">  </span><span class="kw">gather</span>(PredPrey, PopulationSize, <span class="op">-</span>time) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># the minus means use all columns except that one</span></a>
<a class="sourceLine" id="cb34-6" data-line-number="6"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> time, <span class="dt">y =</span> PopulationSize, <span class="dt">color =</span> PredPrey)) <span class="op">+</span></a>
<a class="sourceLine" id="cb34-7" data-line-number="7"><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb34-8" data-line-number="8"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="st">&quot;Population size&quot;</span>)</a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
</div>
<div id="a-note-on-using-eulers-method-to-solve-higher-dimensional-systems" class="section level3">
<h3>A note on using Euler’s method to solve higher-dimensional systems</h3>
<p><em>Note</em>: if you are using Euler’s method to solve a two-dimensional system, make sure you calculate the rates of change using the variables from the previous time step. For example, in the predator-prey model, both <span class="math inline">\(\Delta x\)</span> and <span class="math inline">\(\Delta y\)</span> depend on <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>, and it’s important that you calculate <span class="math inline">\(\Delta x\)</span> and <span class="math inline">\(\Delta y\)</span> <em>before</em> updating the values of <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span>.</p>
<p>Here’s an example.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="co"># Define predator-prey equations</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2"></a>
<a class="sourceLine" id="cb35-3" data-line-number="3">dX_dt &lt;-<span class="st"> </span><span class="cf">function</span>(X, Y, a, b) {</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">  <span class="co"># X: number of prey</span></a>
<a class="sourceLine" id="cb35-5" data-line-number="5">  <span class="co"># Y: number of predators</span></a>
<a class="sourceLine" id="cb35-6" data-line-number="6">  <span class="co"># a: growth rate of prey</span></a>
<a class="sourceLine" id="cb35-7" data-line-number="7">  <span class="co"># b: rate at which predators eat prey</span></a>
<a class="sourceLine" id="cb35-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb35-9" data-line-number="9">  <span class="kw">return</span>(a <span class="op">*</span><span class="st"> </span>X <span class="op">-</span><span class="st"> </span>b <span class="op">*</span><span class="st"> </span>Y <span class="op">*</span><span class="st"> </span>X)</a>
<a class="sourceLine" id="cb35-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb35-11" data-line-number="11"></a>
<a class="sourceLine" id="cb35-12" data-line-number="12">dY_dt &lt;-<span class="st"> </span><span class="cf">function</span>(X, Y, c, d) {</a>
<a class="sourceLine" id="cb35-13" data-line-number="13">  <span class="co"># X: number of prey</span></a>
<a class="sourceLine" id="cb35-14" data-line-number="14">  <span class="co"># Y: number of predators</span></a>
<a class="sourceLine" id="cb35-15" data-line-number="15">  <span class="co"># c: growth rate of predators from eating prey</span></a>
<a class="sourceLine" id="cb35-16" data-line-number="16">  <span class="co"># d: death rate for predators</span></a>
<a class="sourceLine" id="cb35-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb35-18" data-line-number="18">  <span class="kw">return</span> (c <span class="op">*</span><span class="st"> </span>X <span class="op">-</span><span class="st"> </span>d <span class="op">*</span><span class="st"> </span>Y)</a>
<a class="sourceLine" id="cb35-19" data-line-number="19">}</a></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="co"># parameters</span></a>
<a class="sourceLine" id="cb36-2" data-line-number="2">a &lt;-<span class="st"> </span><span class="dv">5</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3">b &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb36-4" data-line-number="4">c &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb36-5" data-line-number="5">d &lt;-<span class="st"> </span><span class="fl">0.2</span></a>
<a class="sourceLine" id="cb36-6" data-line-number="6"></a>
<a class="sourceLine" id="cb36-7" data-line-number="7">state &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dt">X =</span> <span class="dv">2</span>, <span class="dt">Y =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb36-8" data-line-number="8"></a>
<a class="sourceLine" id="cb36-9" data-line-number="9">dt &lt;-<span class="st"> </span><span class="fl">0.01</span> <span class="co"># timestep - the smaller, the better</span></a>
<a class="sourceLine" id="cb36-10" data-line-number="10">tmax &lt;-<span class="st"> </span><span class="dv">30</span> <span class="co"># the total time we want to numerically solve for</span></a>
<a class="sourceLine" id="cb36-11" data-line-number="11">points &lt;-<span class="st"> </span>tmax<span class="op">/</span>dt <span class="co"># the number of data points in the simulation - add 1 so that we can start at t=0</span></a>
<a class="sourceLine" id="cb36-12" data-line-number="12"></a>
<a class="sourceLine" id="cb36-13" data-line-number="13"><span class="co"># vectors to store values of X, Y, and t at each timestep:</span></a>
<a class="sourceLine" id="cb36-14" data-line-number="14">X_vector &lt;-<span class="st"> </span><span class="kw">numeric</span>(points) <span class="co"># prey population size</span></a>
<a class="sourceLine" id="cb36-15" data-line-number="15">Y_vector &lt;-<span class="st"> </span><span class="kw">numeric</span>(points) <span class="co"># predator population size</span></a>
<a class="sourceLine" id="cb36-16" data-line-number="16">t_vector &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, tmax <span class="op">-</span><span class="st"> </span>dt, <span class="dt">by =</span> dt) <span class="co"># time vector</span></a>
<a class="sourceLine" id="cb36-17" data-line-number="17"></a>
<a class="sourceLine" id="cb36-18" data-line-number="18"><span class="co"># initial condition</span></a>
<a class="sourceLine" id="cb36-19" data-line-number="19">X0 &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb36-20" data-line-number="20">Y0 &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb36-21" data-line-number="21">X_vector[<span class="dv">1</span>] &lt;-<span class="st"> </span>X0</a>
<a class="sourceLine" id="cb36-22" data-line-number="22">Y_vector[<span class="dv">1</span>] &lt;-<span class="st"> </span>Y0</a>
<a class="sourceLine" id="cb36-23" data-line-number="23"></a>
<a class="sourceLine" id="cb36-24" data-line-number="24">X &lt;-<span class="st"> </span>X0 <span class="co"># initialize variable X</span></a>
<a class="sourceLine" id="cb36-25" data-line-number="25">Y &lt;-<span class="st"> </span>Y0 <span class="co"># initialize variable Y</span></a></code></pre></div>
<p>This is the right way to do it.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>points) {</a>
<a class="sourceLine" id="cb37-2" data-line-number="2">  <span class="co"># start at 2 because the initial state is at position 1</span></a>
<a class="sourceLine" id="cb37-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb37-4" data-line-number="4">  <span class="co"># first calculate BOTH dX and dY</span></a>
<a class="sourceLine" id="cb37-5" data-line-number="5">  dX &lt;-<span class="st"> </span><span class="kw">dX_dt</span>(<span class="dt">X =</span> X, <span class="dt">Y =</span> Y, <span class="dt">a =</span> a, <span class="dt">b =</span> b) <span class="op">*</span><span class="st"> </span>dt</a>
<a class="sourceLine" id="cb37-6" data-line-number="6">  dY &lt;-<span class="st"> </span><span class="kw">dY_dt</span>(<span class="dt">X =</span> X, <span class="dt">Y =</span> Y, <span class="dt">c =</span> c, <span class="dt">d =</span> d) <span class="op">*</span><span class="st"> </span>dt</a>
<a class="sourceLine" id="cb37-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb37-8" data-line-number="8">  <span class="co"># now update BOTH X and Y</span></a>
<a class="sourceLine" id="cb37-9" data-line-number="9">  X &lt;-<span class="st"> </span>X <span class="op">+</span><span class="st"> </span>dX </a>
<a class="sourceLine" id="cb37-10" data-line-number="10">  Y &lt;-<span class="st"> </span>Y <span class="op">+</span><span class="st"> </span>dY</a>
<a class="sourceLine" id="cb37-11" data-line-number="11">  X_vector[i] &lt;-<span class="st"> </span>X</a>
<a class="sourceLine" id="cb37-12" data-line-number="12">  Y_vector[i] &lt;-<span class="st"> </span>Y</a>
<a class="sourceLine" id="cb37-13" data-line-number="13">}</a></code></pre></div>
<p>This is the wrong way.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="op">:</span>points) {</a>
<a class="sourceLine" id="cb38-2" data-line-number="2">  <span class="co"># start at 2 because the initial state is at position 1</span></a>
<a class="sourceLine" id="cb38-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb38-4" data-line-number="4">  <span class="co"># calculate dX and then update X (wrong)</span></a>
<a class="sourceLine" id="cb38-5" data-line-number="5">  dX &lt;-<span class="st"> </span><span class="kw">dX_dt</span>(<span class="dt">X =</span> X, <span class="dt">Y =</span> Y, <span class="dt">a =</span> a, <span class="dt">b =</span> b) <span class="op">*</span><span class="st"> </span>dt</a>
<a class="sourceLine" id="cb38-6" data-line-number="6">  X <span class="op">&lt;</span><span class="st"> </span>X <span class="op">+</span><span class="st"> </span>dX</a>
<a class="sourceLine" id="cb38-7" data-line-number="7">  </a>
<a class="sourceLine" id="cb38-8" data-line-number="8">  <span class="co"># calculate dY and then update Y - this will use the new value of X instead of the old one.</span></a>
<a class="sourceLine" id="cb38-9" data-line-number="9">  dY &lt;-<span class="st"> </span><span class="kw">dY_dt</span>(<span class="dt">X =</span> X, <span class="dt">Y =</span> Y, <span class="dt">c =</span> c, <span class="dt">d =</span> d) <span class="op">*</span><span class="st"> </span>dt</a>
<a class="sourceLine" id="cb38-10" data-line-number="10">  Y &lt;-<span class="st"> </span>Y <span class="op">+</span><span class="st"> </span>dY</a>
<a class="sourceLine" id="cb38-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb38-12" data-line-number="12">  X_vector[i] &lt;-<span class="st"> </span>X</a>
<a class="sourceLine" id="cb38-13" data-line-number="13">  Y_vector[i] &lt;-<span class="st"> </span>Y</a>
<a class="sourceLine" id="cb38-14" data-line-number="14">}</a></code></pre></div>
</div>
<div id="phase-portraits-in-two-dimensions" class="section level3">
<h3>Phase portraits in two dimensions</h3>
<p>Continuing with the predator-prey example: instead of plotting our numerical trajectory as <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> vs. <span class="math inline">\(t\)</span>, we’ll plot <span class="math inline">\(Y\)</span> vs. <span class="math inline">\(X\)</span>: predator population size vs. prey population size.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="kw">ggplot</span>(result) <span class="op">+</span></a>
<a class="sourceLine" id="cb39-2" data-line-number="2"><span class="st">  </span><span class="kw">geom_path</span>(<span class="kw">aes</span>(<span class="dt">x =</span> X, <span class="dt">y =</span> Y, <span class="dt">color =</span> time)) <span class="co"># geom_line connects the dots in the wrong way - try it out and see</span></a></code></pre></div>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<p>A phase portrait in two dimensions has two axes: one for each of the variables in the system. Here, the two variables are <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>, prey and predators. We want to include the same information in this 2D phase portrait as in the 1D portrait: at minimum, we want to mark the fixed points and draw a <strong>vector field</strong>: arrows indicating in which direction the rate of change is for different values of <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span>.</p>
<p>We can also add other information, and in the plot above we haven’t yet drawn arrows or fixed points, but we have drawn a <strong>trajectory</strong> - the dots trace out what happens to <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> over time starting from <span class="math inline">\(X = 2\)</span>, <span class="math inline">\(Y = 2\)</span>. Time is no longer an axis in the plot, but it’s still there, hidden in the path that the populations take.</p>
<p>Comparing these two ways of plotting a trajectory, we can see that oscillations in time look like circular motion in the phase portrait. The GIF below illustrates this.</p>
<div class="figure">
<img src="image/predator-prey.gif" alt="Predator-prey simulation" />
<p class="caption">Predator-prey simulation</p>
</div>
</div>
<div id="drawing-qualitative-phase-portraits-by-hand" class="section level3">
<h3>Drawing qualitative phase portraits by hand</h3>
<p>Before we look at how to add more to phase portraits in R, let’s practice the process by hand to get familiar with it. Let’s use the following two-dimensional system as an example. The two state variables are <span class="math inline">\(x\)</span> (position) and <span class="math inline">\(v\)</span> (velocity), and this is a model of a mass attached to a spring. <span class="math inline">\(dx/dt\)</span> is the rate of change of position, and <span class="math inline">\(dv/dt\)</span> is the rate of change of velocity.</p>
<p><span class="math display">\[\frac{dx}{dt} = v\]</span></p>
<p><span class="math display">\[\frac{dv}{dt} = -\omega^2 x\]</span></p>
<p>We want to draw a <strong>vector field</strong> in two dimensions to show how the system will evolve through time. Our axes are <span class="math inline">\(x\)</span> and <span class="math inline">\(v\)</span>. It doesn’t matter which one is the vertical axis and which one is horizontal, but let’s put <span class="math inline">\(x\)</span> on the x-axis and <span class="math inline">\(v\)</span> on the y-axis. These variables aren’t population sizes, so they can realistically be negative and non-integers.</p>
<p>Next, we choose some pairs of <span class="math inline">\(x\)</span> and <span class="math inline">\(v\)</span> and evaluate both <span class="math inline">\(dx/dt\)</span> and <span class="math inline">\(dv/dt\)</span>, drawing an arrow at <span class="math inline">\((x,v)\)</span> in the direction of the derivative. Let’s also set <span class="math inline">\(\omega = 1\)</span> for convenience. Let’s start with <span class="math inline">\((0,0)\)</span>: both derivatives are 0, so there’s no arrow. For <span class="math inline">\((0,1)\)</span>, <span class="math inline">\(dx/dt = 1\)</span> and <span class="math inline">\(dv/dt = 0\)</span>, so we draw an arrow pointing horizontally in the <span class="math inline">\(+x\)</span> direction. Similarly for <span class="math inline">\((1,0)\)</span>. For <span class="math inline">\((1,1)\)</span>, we draw an arrow that goes <span class="math inline">\(1\)</span> unit in the <span class="math inline">\(x\)</span> direction and <span class="math inline">\(-1\)</span> unit in the <span class="math inline">\(y\)</span> direction. As we keep filling in this grid, we start to get a picture of how the system can behave for different starting points of <span class="math inline">\(x\)</span> and <span class="math inline">\(v\)</span>.</p>
<p>This is analogous to plotting <span class="math inline">\(dN/dt\)</span> vs. <span class="math inline">\(N\)</span> and drawing arrows to the right where <span class="math inline">\(dN/dt\)</span> is positive and arrows to the left when it’s negative, except that now we have to consider that the rate of change is affecting both variables at the same time.</p>
<div id="example" class="section level4">
<h4>Example</h4>
<p>Define a function called <code>mass_spring</code> that uses the format required by <code>ode</code> to calculate and return <span class="math inline">\(dx/dt\)</span> and <span class="math inline">\(dv/dt\)</span>. We will use this function later to plot a phase portrait in R. Remember that the arguments for your function must be called <code>t</code>, <code>y</code>, and <code>parameters</code>.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb40-1" data-line-number="1">mass_spring &lt;-<span class="st"> </span><span class="cf">function</span>(t, y, parameters) {</a>
<a class="sourceLine" id="cb40-2" data-line-number="2">  <span class="co"># calculates dx/dt and dy/dt for a predator-prey model</span></a>
<a class="sourceLine" id="cb40-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb40-4" data-line-number="4">  <span class="co"># t: time at which to evaluate derivatives</span></a>
<a class="sourceLine" id="cb40-5" data-line-number="5">  <span class="co"># y: vector of system variables (c(x, v))</span></a>
<a class="sourceLine" id="cb40-6" data-line-number="6">  <span class="co"># parameters: vector of model parameters (c(omega))</span></a>
<a class="sourceLine" id="cb40-7" data-line-number="7">    </a>
<a class="sourceLine" id="cb40-8" data-line-number="8">  <span class="co"># the state vector y has two elements because we have two variables</span></a>
<a class="sourceLine" id="cb40-9" data-line-number="9">  x &lt;-<span class="st"> </span>y[<span class="dv">1</span>] <span class="co"># position</span></a>
<a class="sourceLine" id="cb40-10" data-line-number="10">  v &lt;-<span class="st"> </span>y[<span class="dv">2</span>] <span class="co"># velocity</span></a>
<a class="sourceLine" id="cb40-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb40-12" data-line-number="12">  omega &lt;-<span class="st"> </span>parameters[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb40-13" data-line-number="13">    </a>
<a class="sourceLine" id="cb40-14" data-line-number="14">  <span class="co"># calculate rate of change</span></a>
<a class="sourceLine" id="cb40-15" data-line-number="15">  dx &lt;-<span class="st"> </span>v</a>
<a class="sourceLine" id="cb40-16" data-line-number="16">  dv &lt;-<span class="st"> </span><span class="op">-</span>omega<span class="op">^</span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb40-17" data-line-number="17">  </a>
<a class="sourceLine" id="cb40-18" data-line-number="18">  <span class="co"># return rate of change</span></a>
<a class="sourceLine" id="cb40-19" data-line-number="19">  <span class="kw">return</span>(<span class="kw">list</span>(<span class="kw">c</span>(dx, dv)))</a>
<a class="sourceLine" id="cb40-20" data-line-number="20">}</a></code></pre></div>
</div>
</div>
<div id="using-phaser-to-draw-phase-portraits-in-r" class="section level3">
<h3>Using <code>phaseR</code> to draw phase portraits in R</h3>
<p><code>phaseR</code> is a package specifically for drawing phase portraits. It can automatically calculate and plot things like trajectories and vector fields.</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="kw">library</span>(phaseR)</a></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb42-1" data-line-number="1">?phaseR</a></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb43-1" data-line-number="1">?flowField <span class="co"># the nice thing about this packages is that it takes functions in the same format as `ode`</span></a></code></pre></div>
<p>Let’s plot a vector field and some trajectories for the predator-prey model.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="co"># plot vector field: on a grid of points, plot an arrow in the direction of dx/dt and dy/dt</span></a>
<a class="sourceLine" id="cb44-2" data-line-number="2">pp_flowField &lt;-<span class="st"> </span><span class="kw">flowField</span>(predator_prey, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">10</span>),</a>
<a class="sourceLine" id="cb44-3" data-line-number="3">                          <span class="dt">parameters =</span> <span class="kw">c</span>(<span class="dt">a =</span> <span class="dv">5</span>, <span class="dt">b =</span> <span class="dv">1</span>, <span class="dt">c =</span> <span class="dv">1</span>, <span class="dt">d =</span> <span class="fl">0.2</span>), <span class="co"># same parameters as before,</span></a>
<a class="sourceLine" id="cb44-4" data-line-number="4">                          <span class="dt">points =</span> <span class="dv">15</span>, <span class="co"># this is the density of grid points on which to plot arrows</span></a>
<a class="sourceLine" id="cb44-5" data-line-number="5">                          <span class="dt">system =</span> <span class="st">&#39;two.dim&#39;</span>, <span class="co"># &#39;two.dim&#39; is default</span></a>
<a class="sourceLine" id="cb44-6" data-line-number="6">                          <span class="dt">add =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb44-7" data-line-number="7"></a>
<a class="sourceLine" id="cb44-8" data-line-number="8"><span class="co"># add trajectories</span></a>
<a class="sourceLine" id="cb44-9" data-line-number="9">pp_trajectory &lt;-<span class="st"> </span><span class="kw">trajectory</span>(predator_prey, </a>
<a class="sourceLine" id="cb44-10" data-line-number="10">                            <span class="co"># y0 is a matrix where each row is pairs of (X, Y) </span></a>
<a class="sourceLine" id="cb44-11" data-line-number="11">                            <span class="dt">y0 =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">8</span>, <span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">8</span>), <span class="dt">ncol =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb44-12" data-line-number="12">                                   <span class="dt">byrow =</span> <span class="ot">TRUE</span>), </a>
<a class="sourceLine" id="cb44-13" data-line-number="13">                            <span class="dt">tlim =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">20</span>), <span class="co"># how far in time to calculate the trajectories</span></a>
<a class="sourceLine" id="cb44-14" data-line-number="14">                            <span class="dt">parameters =</span> <span class="kw">c</span>(<span class="dt">a =</span> <span class="dv">5</span>, <span class="dt">b =</span> <span class="dv">1</span>, <span class="dt">c =</span> <span class="dv">1</span>, <span class="dt">d =</span> <span class="fl">0.2</span>), <span class="dt">system =</span> <span class="st">&quot;two.dim&quot;</span>)</a></code></pre></div>
<pre><code>## Note: col has been reset as required</code></pre>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<div id="example-1" class="section level4">
<h4>Example</h4>
<p>Use <code>phaseR</code> and the function <code>flowField</code> to make a phase portrait for the mass-spring system of differential equations. You will need to use the function you wrote in the previous challenge. Is there a fixed point, and if so, where do you think it is?</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="co"># plot vector field: on a grid of points, plot an arrow in the direction of dx/dt and dv/dt</span></a>
<a class="sourceLine" id="cb46-2" data-line-number="2">mass_spring_flowField &lt;-<span class="st"> </span><span class="kw">flowField</span>(mass_spring, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">3</span>,<span class="dv">3</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">2</span>,<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb46-3" data-line-number="3">                          <span class="dt">parameters =</span> <span class="kw">c</span>(<span class="dt">omega =</span> <span class="fl">0.5</span>), </a>
<a class="sourceLine" id="cb46-4" data-line-number="4">                          <span class="dt">points =</span> <span class="dv">21</span>, </a>
<a class="sourceLine" id="cb46-5" data-line-number="5">                          <span class="dt">system =</span> <span class="st">&#39;two.dim&#39;</span>, <span class="co"># &#39;two.dim&#39; is default</span></a>
<a class="sourceLine" id="cb46-6" data-line-number="6">                          <span class="dt">add =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb46-7" data-line-number="7"></a>
<a class="sourceLine" id="cb46-8" data-line-number="8"><span class="co"># add trajectories - not part of challenge, just for fun.</span></a>
<a class="sourceLine" id="cb46-9" data-line-number="9">mass_spring_trajectory &lt;-<span class="st"> </span><span class="kw">trajectory</span>(mass_spring, </a>
<a class="sourceLine" id="cb46-10" data-line-number="10">                            <span class="co"># y0 is a matrix where each row is pairs of (X, Y) </span></a>
<a class="sourceLine" id="cb46-11" data-line-number="11">                            <span class="dt">y0 =</span> <span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="fl">-1.5</span>), <span class="dt">ncol =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb46-12" data-line-number="12">                                 <span class="dt">byrow =</span> <span class="ot">TRUE</span>), </a>
<a class="sourceLine" id="cb46-13" data-line-number="13">                            <span class="dt">tlim =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">20</span>), <span class="co"># how far in time to calculate the trajectories</span></a>
<a class="sourceLine" id="cb46-14" data-line-number="14">                            <span class="dt">parameters =</span> <span class="kw">c</span>(<span class="dt">omega =</span> <span class="fl">0.5</span>), </a>
<a class="sourceLine" id="cb46-15" data-line-number="15">                            <span class="dt">system =</span> <span class="st">&quot;two.dim&quot;</span>)</a></code></pre></div>
<pre><code>## Note: col has been reset as required</code></pre>
<p><img src="lec12-numerical-models_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
</div>
</div>
<div id="lotka-volterra-predator-prey-model" class="section level3">
<h3>Lotka-Volterra Predator-Prey model</h3>
<div class="figure">
<img src="image/lotka-volterra.gif" alt="Lotka-Volterra system simulation" />
<p class="caption">Lotka-Volterra system simulation</p>
</div>
<pre><code># caution: this is slow

library(animation)
library(ggplot2)

ani.options(interval=.00001)

# dynamical equations for the lotka-volterra predator-prey model
dotx &lt;- function(x,y,alpha,beta){
    return(alpha*x - beta*x*y)
}

doty &lt;- function(x,y,gamma,delta){
    return(delta*x*y - gamma*y)
}

# parameters
alpha &lt;- 0.5
beta &lt;- 0.6
gamma &lt;- 0.5
delta &lt;- 0.5

dt &lt;- 0.1 #timestep - should really be smaller for accuracy
tmax &lt;- 30
points &lt;- tmax/dt

t_vector &lt;- seq(dt, tmax, by = dt)

xinit &lt;- 0.5
yinit &lt;- 0.5

# vectors to store simulation
x_vector &lt;- numeric(points); y_vector&lt;-numeric(points)

# initialize variables
x &lt;- xinit
y &lt;- yinit

x_vector[1] &lt;- x
y_vector[1] &lt;- y


saveGIF({
    par(mfrow=c(1,2))
    count &lt;- 1
    for (t in t_vector){ 
      dx &lt;- dotx(x,y,alpha,beta)*dt
      dy &lt;- doty(x,y,gamma,delta)*dt
      
      x &lt;- x + dx
      y &lt;- y + dy 
    
      x_vector[count] &lt;- x
      y_vector[count] &lt;- y
      
      data = data.frame(t_vector, x_vector, y_vector)
      plot(x_vector, y_vector, ylim = c(0,2.1), xlim = c(0,2.1)) 
      plot(t_vector[1:count],x_vector[1:count],  ylim = c(0,2.1), xlim = c(0,tmax)) 
      lines(t_vector[1:count],y_vector[1:count])
      count &lt;- count + 1
    }
})

</code></pre>
</div>
<div id="simulation-of-the-logistic-equation" class="section level3">
<h3>Simulation of the logistic equation</h3>
<pre><code>library(animation)
library(ggplot2)

ani.options(interval=.00001)

# dynamical equation for the logistic model
dN_dt &lt;- function(N,r,K) {
  return(r*N*(1-N/K))
}

# parameters
K &lt;- 150
r &lt;- 1

dt &lt;- 0.05 # timestep - should really be smaller for accuracy
tmax &lt;- 7
points &lt;- tmax/dt

t_vector &lt;- seq(dt, tmax, by = dt)

# vectors to store simulation
N_vector &lt;- numeric(points); 

# initialize variables


Nmax &lt;- 300
N_axis &lt;- seq(0, Nmax, by = 0.5)


saveGIF({
    N &lt;- 10
    N_vector[1] &lt;- N
    
    par(mfrow=c(2,1))
    count &lt;- 1
    for (t in t_vector){ 
      dN &lt;- dN_dt(N, r, K)*dt
      N &lt;- N + dN
      N_vector[count] &lt;- N
      
      plot(N,0, ylim = c(-0.2,0.2), xlim = c(0,Nmax), ylab = &quot;&quot;) 
      lines(N_axis, 0*N_axis)
      plot(t_vector[1:count],N_vector[1:count],  
           ylim = c(0,Nmax), xlim = c(0,tmax), 
           xlab = &quot;Time&quot;, ylab = &quot;N&quot;) 
      lines(t_vector, (numeric(points) + 1)*K)
      count &lt;- count + 1
    }
    
    N &lt;- 290
    par(mfrow=c(2,1))
    count &lt;- 1
    for (t in t_vector){ 
      dN &lt;- dN_dt(N, r, K)*dt
      N &lt;- N + dN
      N_vector[count] &lt;- N
      
      plot(N,0, ylim = c(-0.2,0.2), xlim = c(0,Nmax), ylab = &quot;&quot;) 
      lines(N_axis, 0*N_axis)
      plot(t_vector[1:count],N_vector[1:count],  
           ylim = c(0,Nmax), xlim = c(0,tmax), 
           xlab = &quot;Time&quot;, ylab = &quot;N&quot;) 
      lines(t_vector, (numeric(points) + 1)*K)
      count &lt;- count + 1
    }
})</code></pre>
</div>
</div>


<hr>

<p>This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. See the <a href="LICENSE.html">licensing</a> page for more details about copyright information.</p>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3,h4",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = false;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
